<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Groupe 42</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" type="text/javascript;charset=utf-8"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"></script>

    <script src="https://code.jquery.com/jquery-2.1.3.min.js" type="text/javascript"></script>
    <script src="https://d3js.org/d3.v3.min.js" type="text/javascript"></script>
    <script>
        d3v3 = d3
        window.d3 = null
    </script>
    <script src="https://d3js.org/d3.v4.min.js" type="text/javascript"></script>
    <script src='../lib/d3.cloud.layout.js' type="text/javascript"></script>
    <script src="https://d3js.org/d3-color.v1.min.js"></script>
    <script src="https://d3js.org/d3-interpolate.v1.min.js"></script>
    <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
</head>
<style>
    body {
        background-color: #e9ebee;
    }

    #wordcloudsvg {
        position: absolute;
    }

    #button {
        text-align: center;
    }

    .province {
        fill: #000;
        stroke: #fff;
        stroke-width: 1px;
    }

    .province:hover {
        fill: #666;
    }

    .hidden {
        display: none;
    }

    div.tooltip {
        color: #222;
        background-color: #fff;
        padding: .5em;
        text-shadow: #f5f5f5 0 1px 0;
        border-radius: 2px;
        opacity: 0.9;
        position: absolute;
    }

    .line {
        stroke: #ccc;
        stroke-width: 2;
        fill: none;
    }

    .axis path,
    .axis line {
        fill: none;
        stroke: grey;
        stroke-width: 1;
        shape-rendering: crispEdges;
    }

    #legendContainer {
        position: absolute;
        top: 60px;
        left: 10px;
        overflow: auto;
        height: 490px;
        width: 110px;
    }

    #legend {
        width: 90px;
        height: 200px;
    }

    .legend {
        font-size: 12px;
        font-weight: normal;
        text-anchor: left;
    }

    .legendcheckbox {
        cursor: pointer;
    }

    input {
        border-radius: 5px;
        padding: 5px 10px;
        background: #999;
        border: 0;
        color: #fff;
    }
</style>

<body id='body'>
    <div class="container-fluid" id='main'>
        <div class="row">
            <div class="col-md-6">
                <h1>Groupe 42</h1>
            </div>
            <div class="col-md-6">
                <form class="form-inline">
                    <div class="form-group mx-sm-3 mt-2">
                        <label class="mr-sm-2" for="events">Evènement :</label>
                        <select class="form-control" id="events">
                        </select>
                    </div>
                    <a href="#" class="btn btn-info mt-2 ml-sm-2" role="button" id="switch">Map Chart</a>
                </form>
            </div>
        </div>
    </div>

    <div class="container-fluid">
        <div class="row">
            <div class="col-md-12">
                <div id="linechart"></div>
            </div>
        </div>
    </div>

    <script>
        function filterJSON(json, key, value) {
            var result = [];
            json.forEach(function (val, idx, arr) {
                if (val[key] == value) {

                    result.push(val)
                }
            })
            return result;
        }

        function linechart() {

            // Set the dimensions of the canvas / graph
            // var margin = { top: 50, right: 20, bottom: 30, left: 160 }
            var margin = { top: 50, right: 20, bottom: 30, left: 70 },
                width = 1000 - margin.left - margin.right,
                height = 550 - margin.top - margin.bottom;
            // Parse the date / time
            // Set the ranges
            var x = d3v3.time.scale().range([0, width]);
            var y = d3v3.scale.linear().range([height, 0]);
            // Define the axes
            var xAxis = d3v3.svg.axis().scale(x)
                .orient("bottom").ticks(15)
            var yAxis = d3v3.svg.axis().scale(y)
                .orient("left").ticks(5);
            // Define the line
            var stateline = d3v3.svg.line()
                .interpolate("cardinal")
                .x(function (d) { return x(d.year); })
                .y(function (d) { return y(d.value); });
            // Adds the svg canvas
            var svg = d3v3.select("#linechart")
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .attr("id", "line")
                .append("g")
                .attr("transform",
                    "translate(" + margin.left + "," + margin.top + ")");
            var data;
            // Get the data
            d3v3.json("data.json", function (error, json) {

                json.forEach(function (d) {
                    d.value = +d.value;
                });
                d3v3.select('#events')
                    .on("change", function () {
                        var sect = document.getElementById("events");
                        var section = sect.options[sect.selectedIndex].value;
                        data = filterJSON(json, 'produce', section);

                        //debugger

                        data.forEach(function (d) {
                            d.value = +d.value;
                            //d.year = parseDate(String(d.year));
                            d.active = true;
                        });


                        //debugger
                        updateGraph(data);
                        jQuery('h1.page-header').html(section);
                    });
                // generate initial graph
                data = filterJSON(json, 'produce', test.value);
                updateGraph(data);
            });
            var color = d3v3.scale.ordinal().range(["#48A36D", "#0096ff", "#ff007e"]);
            function updateGraph(data) {

                // Scale the range of the data
                x.domain(d3v3.extent(data, function (d) { return d.year; }));
                y.domain([d3v3.min(data, function (d) { return d.value; }), d3v3.max(data, function (d) { return d.value; })]);
                // Nest the entries by state
                dataNest = d3v3.nest()
                    .key(function (d) { return d.state; })
                    .entries(data);
                var result = dataNest.filter(function (val, idx, arr) {
                    return $("." + val.key).attr("fill") != "#ccc"
                    // matching the data with selector status
                })


                var state = svg.selectAll(".line")
                    .data(result, function (d) { return d.key });
                state.enter().append("path")
                    .attr("class", "line");
                state.transition()
                    .style("stroke", function (d, i) { return d.color = color(d.key); })
                    .attr("id", function (d) { return 'tag' + d.key.replace(/\s+/g, ''); }) // assign ID
                    .attr("d", function (d) {

                        return stateline(d.values)
                    });
                state.exit().remove();
                var legend = d3v3.select("#legend")
                    .selectAll("text")
                    .data(dataNest, function (d) { return d.key });
                //checkboxes
                legend.enter().append("rect")
                    .attr("width", 10)
                    .attr("height", 10)
                    .attr("x", 0)
                    .attr("y", function (d, i) { return 0 + i * 15; }) // spacing
                    .attr("fill", function (d) {
                        return color(d.key);

                    })
                    .attr("class", function (d, i) { return "legendcheckbox " + d.key })
                    .on("click", function (d) {
                        d.active = !d.active;

                        d3v3.select(this).attr("fill", function (d) {
                            if (d3v3.select(this).attr("fill") == "#ccc") {
                                return color(d.key);
                            } else {
                                return "#ccc";
                            }
                        })


                        var result = dataNest.filter(function (val, idx, arr) {
                            return $("." + val.key).attr("fill") != "#ccc"
                            // matching the data with selector status
                        })

                        // Hide or show the lines based on the ID
                        svg.selectAll(".line").data(result, function (d) { return d.key })
                            .enter()
                            .append("path")
                            .attr("class", "line")
                            .style("stroke", function (d, i) { return d.color = color(d.key); })
                            .attr("d", function (d) {
                                return stateline(d.values);
                            });

                        svg.selectAll(".line").data(result, function (d) { return d.key }).exit().remove()

                    })

                // Add the Legend text
                legend.enter().append("text")
                    .attr("x", 15)
                    .attr("y", function (d, i) { return 10 + i * 15; })
                    .attr("class", "legend");
                legend.transition()
                    .style("fill", "#777")
                    .text(function (d) { return d.key; });
                legend.exit().remove();
                svg.selectAll(".axis").remove();
                // Add the X Axis
                svg.append("g")
                    .attr("class", "x axis")
                    .attr("transform", "translate(0," + height + ")")
                    .call(xAxis);
                // Add the Y Axis
                svg.append("g")
                    .attr("class", "y axis")
                    .call(yAxis);
            };
        }
    </script>
    <script>
        function mapchart() {

            var width = 875,
                height = 501;

            var svg2 = d3.select("body")
                .append("svg")
                .attr("width", width)
                .attr("height", height)
                // .attr('transform','translate(-75,0)')
                .attr("id", "mapchart");

            var projection = d3.geoAlbersUsa().translate([width / 2, height / 2])
            var path = d3.geoPath().projection(projection);

            var tooltip = d3.select("body").append("div")
                .attr("class", "hidden tooltip")
                .attr("id", 'tooltip');

            // map

            d3.json("us_states.json", function (json) {

                // on r�cup�re les valeurs de sum_scaled
                var values = [];
                for (var i = 0; i < json.features.length; i++) {
                    values.push(json.features[i][test.value + "_scaled"].total_damages);
                }
                var color = d3.scaleSequential(d3.interpolateYlOrRd)
                    .domain([d3.min(values), d3.max(values)]);

                svg2.selectAll("path")
                    .data(json.features)
                    .enter()
                    .append("path")
                    .attr("d", path)
                    .style("fill", function (d) {
                        var value = d[test.value + "_scaled"].total_damages;
                        if (value) { return color(value); } else { return "#ccc"; }
                    })
                    .on("mousemove", function (d) {
                        d3.select(this).style("stroke","#000000");
                        var mouse = d3.mouse(svg2.node()).map(function (d) { return parseInt(d); });
                        tooltip.classed("hidden", false)
                            .attr("style", "left:" + (mouse[0] + 15) + "px;top:" + (mouse[1] - 35) + "px")
                            .html("<center><b>" + d.properties.name +"</b></br><i>" + d[test.value].nb_event + " events</i></br>Injuries : " + d[test.value].total_injuries + "</br>" +  "Deaths : "+ d[test.value].total_deaths + "</br>" + "Damage : " + d[test.value].total_damages + " $ </center>" );
                    })
                    .on("mouseout", function () {
                        d3.select(this).style("stroke","");
                        tooltip.classed("hidden", true);
                    }
                    );

                d3.select('#events')
                    .on("change", function () {
                        // on r�cup�re les valeurs de sum_scaled
                        var values = [];
                        for (var i = 0; i < json.features.length; i++) {
                            values.push(json.features[i][test.value + "_scaled"].sum_scaled);
                        }
                        var color = d3.scaleSequential(d3.interpolateYlOrRd)
                            .domain([d3.min(values), d3.max(values)]);
                        // svg
                        svg2.selectAll("path")
                            .transition(duration=500)
                            .style("fill", function (d) {
                                var value = d[test.value + "_scaled"].sum_scaled;
                                if (value) { return color(value); } else { return "#ccc"; }
                            })

                    });

            }
            )
        }
    </script>
    <script>
        var form = d3v3.select('#events');

        d3v3.json('./events.json', function (err, data) {
            form.selectAll('option')
                .data(data)
                .enter()
                .append('option')
                .attr('value', function (d) {
                    return d.name;
                })
                .text(function (d) {
                    return d.name;
                });
        });

        var test = document.getElementById('events');

        linechart();

        var bt = document.getElementById('switch');
        bt.addEventListener('click', function () {
            if (bt.value == 1) {
                bt.value = 2;
                bt.text = 'Map Chart';
                var map = document.getElementById('mapchart')
                var tooltip = document.getElementById('tooltip')
                var wordcloudel = document.getElementById('wordcloudsvg')
                document.getElementById('body').removeChild(map)
                document.getElementById('body').removeChild(tooltip)
                document.getElementById('body').removeChild(wordcloudel)
                linechart();
            } else {
                bt.value = 1;
                bt.text = 'Line Chart';
                var line = document.getElementById('line')
                document.getElementById('linechart').removeChild(line);
                mapchart();
                wordcloud();
            }
        });

    </script>
    <script>
        // First define your cloud data, using `text` and `size` properties:

        var widthcloud = 500;
        var heightcloud = 500;
        var fill = d3.scaleOrdinal(d3.schemeCategory20);

        function wordcloud() {


            var skillsToDraw = [{ "text": "Oklahoma", "size": 50 }, { "text": "Kansas", "size": 38 }, { "text": "Colorado", "size": 33 }, { "text": "Nebraska", "size": 33 }, { "text": "Arkansas", "size": 33 }, { "text": "Louisiana", "size": 33 }, { "text": "Texas", "size": 32 }, { "text": "Missouri", "size": 31 }, { "text": "Minnesota", "size": 31 }, { "text": "Rhode Island", "size": 30 }, { "text": "Mississippi", "size": 29 }, { "text": "Kentucky", "size": 29 }, { "text": "Connecticut", "size": 29 }, { "text": "South Dakota", "size": 28 }, { "text": "South Carolina", "size": 28 }, { "text": "Florida", "size": 27 }, { "text": "Alabama", "size": 27 }, { "text": "Wyoming", "size": 26 }, { "text": "North Dakota", "size": 26 }, { "text": "Georgia", "size": 25 }, { "text": "Tennessee", "size": 25 }, { "text": "North Carolina", "size": 24 }, { "text": "Montana", "size": 23 }, { "text": "New Jersey", "size": 22 }, { "text": "Massachusetts", "size": 21 }, { "text": "New York", "size": 21 }, { "text": "Indiana", "size": 20 }, { "text": "Illinois", "size": 20 }, { "text": "New Mexico", "size": 19 }, { "text": "Iowa", "size": 18 }, { "text": "Washington", "size": 18 }, { "text": "Maryland", "size": 59 }, { "text": "Ohio", "size": 16 }, { "text": "Idaho", "size": 16 }, { "text": "Virginia", "size": 15 }, { "text": "West Virginia", "size": 15 }, { "text": "Wisconsin", "size": 15 }, { "text": "Maine", "size": 14 }, { "text": "New Hampshire", "size": 14 }, { "text": "Pennsylvania", "size": 13 }, { "text": "Delaware", "size": 13 }, { "text": "Michigan", "size": 11 }, { "text": "Arizona", "size": 10 }, { "text": "Vermont", "size": 10 }, { "text": "Utah", "size": 10 }, { "text": "Hawaii", "size": 9 }, { "text": "Oregon", "size": 8 }, { "text": "Alaska", "size": 7 }, { "text": "Washington D.C.", "size": 6 }, { "text": "California", "size": 3 }, { "text": "Nevada", "size": 2 }];

            // Next you need to use the layout script to calculate the placement, rotation and size of each word:




            d3.layout.cloud()
                .size([widthcloud, heightcloud])
                .words(skillsToDraw)
                .rotate(function () {
                    return ~~(Math.random() * 2) * 90;
                })
                .font("Impact")
                .fontSize(function (d) {
                    return d.size;
                })
                .on("end", drawSkillCloud)
                .start();
        }
        // Finally implement `drawSkillCloud`, which performs the D3 drawing:

        // apply D3.js drawing API
        function drawSkillCloud(words) {
            d3.select("body").append("svg")
                .attr("width", widthcloud)
                .attr("height", heightcloud)
                .attr('transform', 'translate(-75,0)')
                .attr('id', 'wordcloudsvg')
                .append("g")
                .attr("transform", "translate(" + ~~(widthcloud / 2) + "," + ~~(heightcloud / 2) + ")")
                .selectAll("text")
                .data(words)
                .enter().append("text")
                .style("font-size", function (d) {
                    return d.size + "px";
                })
                .style("-webkit-touch-callout", "none")
                .style("-webkit-user-select", "none")
                .style("-khtml-user-select", "none")
                .style("-moz-user-select", "none")
                .style("-ms-user-select", "none")
                .style("user-select", "none")
                .style("cursor", "default")
                .style("font-family", "Impact")
                .style("fill", function (d, i) {
                    return fill(i);
                })
                .attr("text-anchor", "middle")
                .attr("transform", function (d) {
                    return "translate(" + [d.x, d.y] + ")rotate(" + d.rotate + ")";
                })
                .text(function (d) {
                    return d.text;
                });
        }

    </script>
</body>

</html>
